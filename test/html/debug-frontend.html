<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯æ•°æ®æµè°ƒè¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .data { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 3px; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>ğŸ” å‰ç«¯æ•°æ®æµè°ƒè¯•</h1>
    
    <div class="section">
        <h3>ğŸ“Š APIæµ‹è¯•</h3>
        <button onclick="testAPI()">æµ‹è¯•API</button>
        <button onclick="testStore()">æµ‹è¯•Store</button>
        <button onclick="testVue()">æµ‹è¯•Vueå“åº”æ€§</button>
        <div id="apiResult" class="data"></div>
    </div>

    <div class="section">
        <h3>ğŸ“¦ æ•°æ®çŠ¶æ€</h3>
        <div id="dataStatus" class="data">ç­‰å¾…æµ‹è¯•...</div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/vuex@4/dist/vuex.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    
    <script>
        const { createApp, ref, computed, watch } = Vue;
        const { createStore } = Vuex;

        // åˆ›å»ºç®€åŒ–çš„store
        const store = createStore({
            state: {
                resources: [],
                loading: false,
                error: null
            },
            getters: {
                sortedResources(state) {
                    console.log('ğŸ” sortedResources getter è¢«è°ƒç”¨');
                    console.log('state.resources:', state.resources);
                    console.log('state.resources ç±»å‹:', typeof state.resources);
                    console.log('state.resources æ˜¯å¦ä¸ºæ•°ç»„:', Array.isArray(state.resources));
                    console.log('state.resources é•¿åº¦:', state.resources ? state.resources.length : 'null/undefined');
                    
                    if (!state.resources || !Array.isArray(state.resources)) {
                        console.warn('âŒ state.resources ä¸æ˜¯æ•°ç»„ï¼Œè¿”å›ç©ºæ•°ç»„');
                        return [];
                    }
                    
                    const sorted = [...state.resources].sort((a, b) => {
                        if (a.group < b.group) return -1;
                        if (a.group > b.group) return 1;
                        if (a.name < b.name) return -1;
                        if (a.name > b.name) return 1;
                        return 0;
                    });
                    
                    console.log('âœ… æ’åºåçš„èµ„æºæ•°é‡:', sorted.length);
                    return sorted;
                }
            },
            mutations: {
                setResources(state, resources) {
                    console.log('ğŸ”„ setResources mutation è¢«è°ƒç”¨');
                    console.log('ä¼ å…¥çš„ resources:', resources);
                    console.log('ä¼ å…¥çš„ resources ç±»å‹:', typeof resources);
                    console.log('ä¼ å…¥çš„ resources æ˜¯å¦ä¸ºæ•°ç»„:', Array.isArray(resources));
                    console.log('ä¼ å…¥çš„ resources é•¿åº¦:', resources ? resources.length : 'null/undefined');
                    
                    state.resources = Array.isArray(resources) ? [...resources] : [];
                    
                    console.log('âœ… è®¾ç½®åçš„ state.resources é•¿åº¦:', state.resources.length);
                },
                setLoading(state, loading) {
                    state.loading = loading;
                },
                setError(state, error) {
                    state.error = error;
                }
            },
            actions: {
                async fetchResources({ commit }) {
                    commit('setLoading', true);
                    commit('setError', null);
                    try {
                        console.log('ğŸš€ å¼€å§‹è·å–èµ„æº...');
                        const response = await axios.get('/api/crds');
                        console.log('ğŸ“¥ APIå“åº”:', response);
                        console.log('ğŸ“Š å“åº”æ•°æ®é•¿åº¦:', response.data ? response.data.length : 'null');
                        
                        if (response.data && Array.isArray(response.data)) {
                            commit('setResources', response.data);
                        } else {
                            throw new Error('Invalid data format');
                        }
                    } catch (error) {
                        console.error('âŒ è·å–èµ„æºå¤±è´¥:', error);
                        commit('setError', error.message);
                    } finally {
                        commit('setLoading', false);
                    }
                }
            }
        });

        // åˆ›å»ºVueåº”ç”¨
        const app = createApp({
            setup() {
                const sortedResources = computed(() => store.getters.sortedResources);
                const loading = computed(() => store.state.loading);
                const error = computed(() => store.state.error);
                
                // ç›‘å¬æ•°æ®å˜åŒ–
                watch(sortedResources, (resources) => {
                    console.log('ğŸ‘€ sortedResources å˜åŒ–:', resources);
                    console.log('ğŸ“Š èµ„æºæ•°é‡:', resources ? resources.length : 0);
                    updateDataStatus();
                }, { immediate: true, deep: true });
                
                watch(() => store.state.resources, (resources) => {
                    console.log('ğŸ‘€ store.state.resources å˜åŒ–:', resources);
                    console.log('ğŸ“Š åŸå§‹èµ„æºæ•°é‡:', resources ? resources.length : 0);
                    updateDataStatus();
                }, { immediate: true, deep: true });
                
                function updateDataStatus() {
                    const statusDiv = document.getElementById('dataStatus');
                    if (statusDiv) {
                        statusDiv.innerHTML = `
                            <div><strong>ğŸ“Š æ•°æ®çŠ¶æ€:</strong></div>
                            <div>åŸå§‹èµ„æºæ•°: ${store.state.resources ? store.state.resources.length : 0}</div>
                            <div>æ’åºèµ„æºæ•°: ${sortedResources.value ? sortedResources.value.length : 0}</div>
                            <div>åŠ è½½çŠ¶æ€: ${loading.value ? 'åŠ è½½ä¸­' : 'å·²å®Œæˆ'}</div>
                            <div>é”™è¯¯çŠ¶æ€: ${error.value || 'æ— '}</div>
                            <div>Storeç±»å‹: ${typeof store.state.resources}</div>
                            <div>Storeæ˜¯æ•°ç»„: ${Array.isArray(store.state.resources)}</div>
                        `;
                    }
                }
                
                return {
                    sortedResources,
                    loading,
                    error,
                    updateDataStatus
                };
            }
        });
        
        app.use(store);
        app.mount('#app');

        // æµ‹è¯•å‡½æ•°
        async function testAPI() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = 'ğŸ”„ æµ‹è¯•API...';
            
            try {
                const response = await axios.get('/api/crds');
                console.log('ğŸ” ç›´æ¥APIæµ‹è¯•:', response);
                
                resultDiv.innerHTML = `
                    <div><strong>âœ… APIæµ‹è¯•æˆåŠŸ</strong></div>
                    <div>çŠ¶æ€ç : ${response.status}</div>
                    <div>æ•°æ®ç±»å‹: ${typeof response.data}</div>
                    <div>æ˜¯å¦ä¸ºæ•°ç»„: ${Array.isArray(response.data)}</div>
                    <div>æ•°æ®é•¿åº¦: ${response.data ? response.data.length : 'null'}</div>
                    <div>å‰3ä¸ªèµ„æº: ${JSON.stringify(response.data.slice(0, 3), null, 2)}</div>
                `;
            } catch (error) {
                console.error('âŒ APIæµ‹è¯•å¤±è´¥:', error);
                resultDiv.innerHTML = `<div><strong>âŒ APIæµ‹è¯•å¤±è´¥:</strong> ${error.message}</div>`;
            }
        }

        async function testStore() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = 'ğŸ”„ æµ‹è¯•Store...';
            
            try {
                await store.dispatch('fetchResources');
                
                resultDiv.innerHTML = `
                    <div><strong>âœ… Storeæµ‹è¯•å®Œæˆ</strong></div>
                    <div>Storeèµ„æºæ•°: ${store.state.resources ? store.state.resources.length : 0}</div>
                    <div>Getterèµ„æºæ•°: ${store.getters.sortedResources ? store.getters.sortedResources.length : 0}</div>
                    <div>åŠ è½½çŠ¶æ€: ${store.state.loading}</div>
                    <div>é”™è¯¯çŠ¶æ€: ${store.state.error || 'æ— '}</div>
                `;
            } catch (error) {
                console.error('âŒ Storeæµ‹è¯•å¤±è´¥:', error);
                resultDiv.innerHTML = `<div><strong>âŒ Storeæµ‹è¯•å¤±è´¥:</strong> ${error.message}</div>`;
            }
        }

        function testVue() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = 'ğŸ”„ æµ‹è¯•Vueå“åº”æ€§...';
            
            // æ‰‹åŠ¨è§¦å‘å“åº”æ€§æ›´æ–°
            const testData = [
                { group: 'test', version: 'v1', name: 'test1', kind: 'Test1', namespaced: true },
                { group: 'test', version: 'v1', name: 'test2', kind: 'Test2', namespaced: false }
            ];
            
            store.commit('setResources', testData);
            
            setTimeout(() => {
                resultDiv.innerHTML = `
                    <div><strong>âœ… Vueå“åº”æ€§æµ‹è¯•å®Œæˆ</strong></div>
                    <div>æµ‹è¯•æ•°æ®å·²è®¾ç½®</div>
                    <div>Storeèµ„æºæ•°: ${store.state.resources ? store.state.resources.length : 0}</div>
                    <div>Getterèµ„æºæ•°: ${store.getters.sortedResources ? store.getters.sortedResources.length : 0}</div>
                `;
            }, 100);
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
        window.onload = function() {
            console.log('ğŸš€ è°ƒè¯•é¡µé¢å·²åŠ è½½');
            testAPI();
        };
    </script>
    
    <div id="app"></div>
</body>
</html> 